name: Nightly Test Suite

on:
  schedule:
    - cron: '0 0 * * *'  # 00:00 UTC = 02:00 EET, matching local cron schedule
  workflow_dispatch:       # allow manual trigger from GitHub UI

jobs:
  test:
    name: Run API Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Set up Python 3
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Run tests
        id: run_tests
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          mkdir -p TestResults reports
          dotnet test \
            --no-restore \
            --logger "trx;LogFileName=results-$TIMESTAMP.trx" \
            --logger "console;verbosity=normal" \
            --results-directory ./TestResults \
            2>&1 | tee reports/test-run-$TIMESTAMP.log
        continue-on-error: true

      - name: Generate HTML report
        if: always()
        run: |
          TIMESTAMP="${{ steps.run_tests.outputs.timestamp }}"
          TRX="TestResults/results-$TIMESTAMP.trx"
          REPORT="reports/test-report-$TIMESTAMP.html"
          if [ -f "$TRX" ] && [ -f "generate_report.py" ]; then
            python3 generate_report.py "$TRX" "$REPORT"
          fi

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}
          path: |
            TestResults/
            reports/
          retention-days: 30

      - name: Fail if tests failed
        if: steps.run_tests.outcome == 'failure'
        run: exit 1
